########### Quality assessment and trimming of P.hybrida S3LS3L Illumina reads, Genome Survey ###########
### fastqc quality assessment
  fastqc read_R1.fastq.gz -o ./
  fastqc read_R2.fastq.gz -o ./
### fastp trimming
	fastp -i read_R1.fastq.gz -I read_R2.fastq.gz -o read_clean.R1.fastq.gz -O read_clean.R2.fastq.gz -q 20 -n 0 -w 8
### jellyfish
  jellyfish count -m 17 -s 5G -t 16 -o Survey_fastp_k17.jf -C <(zcat read_clean.R1.fastq.gz) <(zcat read_clean.R2.fastq.gz) > jellyfish-survey-fastp-k17.log 2>&1 &
  jellyfish histo -l 1 -h 10000 -t 4 ./Survey_fastp_k17.jf > S3LSurvey_fastp_k17.jf.10000.histo &
  jellyfish histo -l 1 -h 1000000 -t 4 ./Survey_fastp_k17.jf > S3LSurvey_fastp_k17.jf.1000000.histo &
### GenomeScope analyzing
  Rscript /xtdisk/xueyb_group/wangchenA/software/genomescope-master/genomescope.R S3LSurvey_fastp_k17.jf.1000000.histo 17 150 ./histo-1000000/

########### hifiasm assembly ###########
hifiasm -o ./S3L.ont.hifi.hic -t 64 --h1 ${hic1} --h2 ${hic2} --ul ${ont} ${hifi}

########### nextDenovo assembly & polish ###########
### nextDenovo assembly
nextDenovo run.cfg
cat run.cfg
[General]
job_type = local # local, slurm, sge, pbs, lsf
job_prefix = S3L_pass_ul
task = all # all, correct, assemble
rewrite = yes # yes/no
deltmp = yes
parallel_jobs = 8 # number of tasks used to run in parallel
input_type = raw # raw, corrected
read_type = ont # clr, ont, hifi
input_fofn = input.fofn
workdir = 01_rundir
#usetempdir = ./tmp_3L/ # usetempdir cannot be used with local
[correct_option]
read_cutoff = 50k
genome_size = 1300M # estimated genome size
sort_options = -m 20g -t 8 #-m 20g -t 15
minimap2_options_raw = -t 8 #-t 8
pa_correction = 3 # number of corrected tasks used to run in parallel, each corrected task requires ~TOTAL_INPUT_BASES/4 bytes of memory usage.
correction_options = -p 8
[assemble_option]
minimap2_options_cns = -t 8
nextgraph_options = -a 1

### nextPolish hifi 3 round polish
nextPolish run.cfg
cat run.cfg
[General]
job_type = local # local, sge, pbs… (default: sge)
job_prefix = S3L_ont_hifiPolish # prefix tag for jobs. (default: nextPolish)
task = best #task need to run [all, default, best, 1, 2, 5, 12, 1212…], 1, 2 are different algorithm modules for short reads, while 5 is the algorithm module for long reads, all=[5]1234, default=[5]12, best=[55]1212. (default: best)
rewrite = yes #overwrite existed directory [yes, no]. (default: no)
deltmp = yes #delete intermediate results. (default: yes)
rerun = 3 #re-run unfinished jobs untill finished or reached ${rerun} loops, 0=no. (default: 3)
parallel_jobs = 6 #number of tasks used to run in parallel. (default: 6)
multithread_jobs = 6 #number of threads used to in a task. (default: 5)
genome = /xtdisk/xueyb_group/wangchenA/Petunia_denovo/S3L_NextDenovo_20240702/01.ont_pass_ul_fq/01_rundir/03.ctg_graph/nd.asm.fasta #
genome_size = auto #genome size, auto = calculate genome size using the input ${genome} file. (default: auto)
workdir = ./01_hifi_polish_r3 #
polish_options = -p {multithread_jobs}
[hifi_option] #optional
hifi_fofn = ./hifi.fofn #input hifi read files list, one file one line.
hifi_options = -min_read_len 10k -max_depth 100
hifi_minimap2_options = -x asm20 -t 36 #minimap2 options, used to set hifi reads mapping. (required)

### nextPolish ngs 4 round polish
nextPolish run.cfg
cat run_sgs.cfg
[General]
job_type = local # local, sge, pbs… (default: sge)
job_prefix = S3L_ont_hifi_sgs_Polish # prefix tag for jobs. (default: nextPolish)
task = best #task need to run [all, default, best, 1, 2, 5, 12, 1212…], 1, 2 are different algorithm modules for short reads, while 5 is the algorithm module for long reads, all=[5]1234, default=[5]12, best=[55]1212. (default: best)
rewrite = yes #overwrite existed directory [yes, no]. (default: no)
deltmp = yes #delete intermediate results. (default: yes)
rerun = 4 #re-run unfinished jobs untill finished or reached ${rerun} loops, 0=no. (default: 3)
parallel_jobs = 6 #number of tasks used to run in parallel. (default: 6)
multithread_jobs = 6 #number of threads used to in a task. (default: 5)
genome = /xtdisk/xueyb_group/wangchenA/Petunia_denovo/S3L_NextDenovo_20240702/02.nextPolish1/01_hifi_polish_r3/genome.nextpolish.fasta #
genome_size = auto #genome size, auto = calculate genome size using the input ${genome} file. (default: auto)
workdir = ./02_sgs_polish_r4 #
polish_options = -p {multithread_jobs}
[sgs_option]
sgs_fofn = ./sgs.fofn #input short read files list, one file one line, paired-end files should be interleaved.
sgs_options = -max_depth 100 -bwa

########### Juicer 3DDNA ###########
software/juicer-1.6/Local/scripts/juicer.sh \
-g hic_hp1 \
-s MboI \
-t 20 \
-d ${dir}/work_hic_hp1 \
-p ${dir}/restriction_sites_hic_hp1/hic_hp1.chrom.sizes \
-y ${dir}/restriction_sites_hic_hp1/hic_hp1_MboI.txt \
-z ${dir}/reference_hic_hp1/hap1.ctg.fa \
-D software/juicer-1.6/Local

run-asm-pipeline.sh \
-r 0 \
04.juicer/reference_hic_hp1/hap1.ctg.wrapped.fasta \
04.juicer/work_hic_hp1/aligned/merged_nodups.txt

run-asm-pipeline-post-review.sh \
-r ./hap1.ctg.wrapped.FINAL.review.assembly \
04.juicer/reference_hic_hp1/hap1.ctg.wrapped.fasta \
04.juicer/work_hic_hp1/aligned/merged_nodups.txt

########### TGS-GapCloser ###########
tgsgapcloser \
--scaff S3L_hap1_gap.fa \
--reads ont.pass.ul.fq.gz \
--output hp1.pilon \
--pilon pilon-1.24.jar \
--ngs S3L.ngs.fastq.gz \
--samtools samtools \
--java /usr/bin/java \
--thread 56 \
--pilon_mem 100G \

########### Repetitive elements annotation ###########
EDTA.pl --genome S3L_hap1_T2T.fa \
--species others \
--step all \
--overwrite 0 \
--curatedlib edcotrep.fa \
--sensitive 1 \
--anno 1 \
--threads 48

### TE-free Protein Database
RepeatPepsLib=repeatmasker_4.1.2.p1/share/RepeatMasker/Libraries/RepeatPeps.lib
makeblastdb -dbtype prot -in $RepeatPepsLib -out RepeatPeps.lib
wget ftp://ftp.ncbi.nlm.nih.gov/blast/db/taxdb.tar.gz
gunzip taxdb.tar.gz
tar -xvf taxdb.tar
blastp -query Solanum.fa -db RepeatPeps.lib -outfmt '6 qseqid staxids bitscore std sscinames sskingdoms stitle' -max_target_seqs 25 -culling_limit 2 -num_threads 8 -evalue 1e-5 -out blastp.out
perl fastaqual_select.pl -f Solanum.fa -e <(awk '{print $1}' blastp.out | sort | uniq) > Solanum_no_TES.fa

### Cleaning and redundancy removal
makeblastdb -in Solanum_no_TES.fa -dbtype prot
blastx -query S3L_hap1.EDTA.TElib.fa -db Solanum_no_TES.fa \
-outfmt '6 qseqid staxids bitscore std sscinames sskingdoms stitle' -max_target_seqs 25 -culling_limit 2 -num_threads 48 -evalue 1e-10 \
-out S3L_hap1_blast.out
perl fastaqual_select.pl -f S3L_hap1.EDTA.TElib.fa -e <(awk '{print $1}' S3L_hap1_blast.out | sort | uniq) > S3L_hap1.EDTA.TElib_noprot.lib
cd-hit-est -i S3L_hap1.EDTA.TElib_noprot.lib -o S3L_hap1.EDTA.TElib_noprot.Final.lib -c 0.95 -n 10 -p 1 -d 0 -T 48 -M 40000 > S3L_hap1_cdhit.repeat_library_95.log

### soft-masking
RepeatMasker -xsmall -e ncbi -lib S3L_hap1.EDTA.TElib_noprot.Final.lib -pa 40 -gff -dir ./S3L_hp1_EDTAlib/ ${fa} -no_is -norna -nolow > S3L_hp1_EDTAlib.mask.log

########### Gene prediction ###########
### RNAser evidence for annotation
hisat2 -p 10 --dta -x S3L_hap1_hisat2/S3L_hap1_mask -1 ${data}/${bam}.clean.R1.fastq.gz -2 ${data}/${bam}.clean.R2.fastq.gz | samtools sort -@ 4 > bam6RNA_S3L_hap1_t2t/${bam}.raw.bam
samtools index bam6RNA_S3L_hap1_t2t/${bam}.raw.bam

### BRAKER3 pipeline for annotation
# tissue-specific RNAseq for leaf, pistil and pollen
bam=03.hisat2/bam6RNA_S3L_hap1
# public RNAseq data of P. hybrida
bam72=03.hisat2/bam72RNA_S3L_hap1
perl braker.pl \
--genome=S3L_hap1.fa.masked \
--bam ${bam}/ZB7-1-Po_L2_L7_UDI378.uniq.bam,${bam}/ZB7-2-1-le_L8_UDI380.uniq.bam,${bam}/ZH-3LB7leaf-1_L1_352X52.uniq.bam,${bam}/ZH-3LB7pistil_L1_353X53.uniq.bam,${bam}/ZH-3LB7pistil_L1_371X71.uniq.bam,${bam}/ZH-3LB7pollen_L1_354X54.uniq.bam,${bam72}/SRR1649125.uniq.bam,${bam72}/SRR1649126.uniq.bam,${bam72}/SRR1649127.uniq.bam,${bam72}/SRR1649128.uniq.bam,${bam72}/SRR1649129.uniq.bam,${bam72}/SRR1649130.uniq.bam,${bam72}/SRR1649131.uniq.bam,${bam72}/SRR1649132.uniq.bam,${bam72}/SRR1649133.uniq.bam,${bam72}/SRR1649134.uniq.bam,${bam72}/SRR1649135.uniq.bam,${bam72}/SRR1649136.uniq.bam,${bam72}/SRR1649137.uniq.bam,${bam72}/SRR1649138.uniq.bam,${bam72}/SRR1649139.uniq.bam,${bam72}/SRR1649140.uniq.bam,${bam72}/SRR1649141.uniq.bam,${bam72}/SRR1649142.uniq.bam,${bam72}/SRR3101741.uniq.bam,${bam72}/SRR3101743.uniq.bam,${bam72}/SRR3101745.uniq.bam,${bam72}/SRR3101747.uniq.bam,${bam72}/SRR3101749.uniq.bam,${bam72}/SRR3101751.uniq.bam,${bam72}/SRR3101753.uniq.bam,${bam72}/SRR3101755.uniq.bam,${bam72}/SRR3101757.uniq.bam,${bam72}/SRR3101759.uniq.bam,${bam72}/SRR3101760.uniq.bam,${bam72}/SRR3101761.uniq.bam,${bam72}/SRR3101768.uniq.bam,${bam72}/SRR3101769.uniq.bam,${bam72}/SRR3101771.uniq.bam,${bam72}/SRR5419465.uniq.bam,${bam72}/SRR5419466.uniq.bam,${bam72}/SRR5419467.uniq.bam,${bam72}/SRR5419468.uniq.bam,${bam72}/SRR5419469.uniq.bam,${bam72}/SRR5419470.uniq.bam,${bam72}/SRR5419471.uniq.bam,${bam72}/SRR5419472.uniq.bam,${bam72}/SRR5419474.uniq.bam,${bam72}/SRR5419475.uniq.bam,${bam72}/SRR5419476.uniq.bam,${bam72}/SRR5419477.uniq.bam,${bam72}/SRR5419478.uniq.bam,${bam72}/SRR5419479.uniq.bam,${bam72}/SRR5419480.uniq.bam,${bam72}/SRR5419481.uniq.bam,${bam72}/SRR5419482.uniq.bam,${bam72}/SRR5419483.uniq.bam,${bam72}/SRR5419484.uniq.bam,${bam72}/SRR5419485.uniq.bam,${bam72}/SRR5419486.uniq.bam,${bam72}/SRR5419487.uniq.bam,${bam72}/SRR5419488.uniq.bam,${bam72}/SRR5419489.uniq.bam,${bam72}/SRR5419490.uniq.bam,${bam72}/SRR5419491.uniq.bam,${bam72}/SRR5419492.uniq.bam,${bam72}/SRR5419493.uniq.bam,${bam72}/SRR5419494.uniq.bam \
--prot_seq=Closed_species_pep.fa \
--species=S3L_hap1 --gff3 \
--AUGUSTUS_ab_initio \
--threads 20 \
--workingdir=S3L_hap1 \
--augustus_args="--genemodel=complete --strand=both --alternatives-from-evidence=true --noInFrameStop=true" \
> S3L_hap1.log 2>&1

